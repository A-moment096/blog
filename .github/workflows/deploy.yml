name: Deploy Hugo Site to GitHub Pages

on:
  push:
    branches: [ main ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    - name: Build with Hugo
      run: hugo --minify

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./public
      
      - name: Extract GitHub Pages artifact
        run: |
          cd public
          tar -xf artifact.tar

      - name: Deploy to public repository
        run: |
          # Configure git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Clone the public repository
          git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/A-moment096/A-moment096.github.io.git public-repo
          cd public-repo
          
          # Switch to gh-pages branch (or create it)
          git checkout gh-pages || git checkout -b gh-pages
          
          # Remove all files except .git
          find . -not -path './.git*' -delete
          
          # Copy static files from Hugo build
          cp -r ../public/* .
          
          # Add a CNAME file if needed for custom domain
          # echo "yourdomain.com" > CNAME
          
          # Commit and push
          git add .
          git commit -m "Deploy static site - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin gh-pages