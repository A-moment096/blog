name: Optimized Deploy to Public GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggers

# Minimal permissions needed
permissions:
  contents: read

# Allow only one concurrent deployment
concurrency:
  group: "dual-repo-deploy"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout private repository
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0  # Need full history for submodules

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: 'latest'
        extended: true

    - name: Build with Hugo
      run: hugo --minify

    - name: Optimized deploy to public repository
      run: |
        # Configure git with bot credentials
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Clone public repo with shallow history for speed
        echo "ğŸ”„ Cloning public repository..."
        git clone --depth=1 https://${{ secrets.DEPLOY_TOKEN }}@github.com/A-moment096/A-moment096.github.io.git public-repo
        cd public-repo
        
        # Switch to gh-pages branch (or create it)
        echo "ğŸ“‚ Switching to gh-pages branch..."
        git checkout gh-pages || git checkout -b gh-pages
        
        # Smart sync: only update changed files (much faster than delete-all)
        echo "ğŸš€ Syncing files efficiently..."
        rsync -av --delete --exclude='.git' --exclude='.github' ../public/ ./
        
        # Add CNAME if you have a custom domain
        # echo "yourdomain.com" > CNAME
        
        # Only commit if there are actual changes
        if [[ -n $(git status --porcelain) ]]; then
          echo "âœ… Changes detected, deploying..."
          git add .
          git commit -m "ğŸš€ Deploy: $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin gh-pages
          echo "ğŸ‰ Site deployed successfully!"
        else
          echo "â„¹ï¸ No changes detected, skipping deployment"
        fi