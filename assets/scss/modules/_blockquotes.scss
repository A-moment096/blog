// =============================================================================
// BLOCKQUOTES MODULE
// GitHub 式引用块样式（重构版本）
// =============================================================================

// Mixin for creating alert styles
@mixin alert-style($border-color, $bg-color, $text-color, $dark-bg-color: null, $dark-text-color: null) {
  border-left-color: $border-color;
  background: linear-gradient(135deg, rgba($bg-color, 0.08) 0%, rgba($bg-color, 0.04) 100%);
  border-radius: 8px;

  .github-alert-title,
  .math-title {
    color: $text-color;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;

    .github-alert-icon svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
  }

  .github-alert-content,
  .math-content {
    margin-top: 8px;

    // 确保数学公式在数学环境中正确渲染
    .katex-display {
      margin: 1em 0;
    }

    .katex {
      font-size: 1em;
    }
  }

  // 暗色模式
  :root[data-scheme="dark"] & {
    @if $dark-bg-color and $dark-text-color {
      background: linear-gradient(135deg, rgba($dark-bg-color, 0.15) 0%, rgba($dark-bg-color, 0.08) 100%);
      border-left-color: $dark-text-color;

      .github-alert-title,
      .math-title {
        color: $dark-text-color;
      }
    }
  }
}

// Mixin for math environments with icons
@mixin math-env-icon($icon-name, $color) {

  .math-title::before {
    content: "";
    width: 16px;
    height: 16px;
    background-image: url('/icons/math-env/#{$icon-name}.svg');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    filter: brightness(0) saturate(100%) #{get-filter-values($color)};
    flex-shrink: 0;
  }
}

// Helper function to generate filter values for different colors
@function get-filter-values($color) {
  @if $color ==#1e40af {
    @return "invert(20%) sepia(88%) saturate(1789%) hue-rotate(221deg) brightness(93%) contrast(91%)";
  }

  // blue
  @if $color ==#059669 {
    @return "invert(39%) sepia(91%) saturate(1276%) hue-rotate(142deg) brightness(91%) contrast(96%)";
  }

  // green  
  @if $color ==#7c3aed {
    @return "invert(35%) sepia(89%) saturate(2466%) hue-rotate(261deg) brightness(87%) contrast(92%)";
  }

  // purple
  @if $color ==#dc2626 {
    @return "invert(29%) sepia(76%) saturate(2063%) hue-rotate(348deg) brightness(90%) contrast(89%)";
  }

  // red
  @if $color ==#ea580c {
    @return "invert(39%) sepia(100%) saturate(1847%) hue-rotate(21deg) brightness(96%) contrast(99%)";
  }

  // orange
  @if $color ==#6b7280 {
    @return "invert(49%) sepia(5%) saturate(1080%) hue-rotate(202deg) brightness(91%) contrast(86%)";
  }

  // gray
  @if $color ==#0891b2 {
    @return "invert(56%) sepia(89%) saturate(1320%) hue-rotate(174deg) brightness(96%) contrast(97%)";
  }

  // cyan
  @if $color ==#9333ea {
    @return "invert(44%) sepia(89%) saturate(2466%) hue-rotate(261deg) brightness(87%) contrast(92%)";
  }

  // violet
  @return "invert(50%)"; // fallback
}

.article-content {
  blockquote {
    border-left: 3px solid var(--accent-color);
    background: var(--blockquote-background-color);
    padding: 16px 20px;
    padding-right: 60px;
    margin: 1.5em 0;
    position: relative;
    border-radius: 8px;
    line-height: 1.6;

    p {
      margin: 0.8em 0;

      &:first-child {
        margin-top: 0;
      }

      &:last-child {
        margin-bottom: 0;
      }
    }

    // 行内代码样式
    code:not(pre code) {
      background: rgba(0, 0, 0, 0.15);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    // 列表样式调整
    ul,
    ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }

    li {
      margin: 0.3em 0;
    }

    // GitHub Alert 样式
    &.github-note {
      @include alert-style(#0969da, #0969da, #0969da, #4dabf7, #4dabf7);
    }

    &.github-tip {
      @include alert-style(#1a7f37, #1a7f37, #1a7f37, #51cf66, #51cf66);
    }

    &.github-important {
      @include alert-style(#8250df, #8250df, #8250df, #9775fa, #9775fa);
    }

    &.github-warning {
      @include alert-style(#ff8c00, #ff8c00, #ff8c00, #ffa500, #ffa500);
    }

    &.github-caution {
      @include alert-style(#d1242f, #d1242f, #d1242f, #ff6b6b, #ff6b6b);
    }

    // Mathematical blockquote styles
    &.math-theorem {
      @include alert-style(#1e40af, #1e40af, #1e40af, #60a5fa, #60a5fa);
      @include math-env-icon('theorem', #1e40af);
    }

    &.math-lemma {
      @include alert-style(#059669, #059669, #059669, #34d399, #34d399);
      @include math-env-icon('lemma', #059669);
    }

    &.math-definition {
      @include alert-style(#7c3aed, #7c3aed, #7c3aed, #a78bfa, #a78bfa);
      @include math-env-icon('definition', #7c3aed);
    }

    &.math-corollary {
      @include alert-style(#dc2626, #dc2626, #dc2626, #f87171, #f87171);
      @include math-env-icon('corollary', #dc2626);
    }

    &.math-proposition {
      @include alert-style(#ea580c, #ea580c, #ea580c, #fb923c, #fb923c);
      @include math-env-icon('proposition', #ea580c);
    }

    &.math-proof {
      @include alert-style(#6b7280, #6b7280, #6b7280, #9ca3af, #9ca3af);
      @include math-env-icon('proof', #6b7280);

      // QED symbol at the end
      &::after {
        content: '';
        background-image: url('/icons/math-env/QED.svg');
        background-size: 18px 18px;
        height: 18px;
        width: 18px;
        position: absolute;
        bottom: 22px;
        right: 60px;
        color: #000000;
      }

      :root[data-scheme="dark"] &::after {
        color: #9ca3af;
      }
    }

    &.math-example {
      @include alert-style(#0891b2, #0891b2, #0891b2, #22d3ee, #22d3ee);
      @include math-env-icon('example', #0891b2);
    }

    &.math-remark {
      @include alert-style(#9333ea, #9333ea, #9333ea, #c084fc, #c084fc);
      @include math-env-icon('remark', #9333ea);
    }
  }

  // 卡片式折叠详情样式 (保持原有样式)
  details {
    background: var(--card-background);
    border-radius: 12px;
    margin: 1.5em 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    border: 1px solid var(--card-border);

    &:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
      border-color: var(--accent-color);
    }

    summary {
      padding: 18px 24px 18px 48px;
      background: linear-gradient(135deg, var(--accent-color-lighter) 0%, var(--accent-color-dim) 100%);
      font-weight: 600;
      color: var(--card-text-color-main);
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: all 0.2s ease;

      &::marker {
        content: "";
      }

      // 左侧动画箭头
      &::before {
        content: "▶";
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        color: var(--accent-color);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: normal;
      }

      &:hover {
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-lighter) 100%);
        color: var(--card-text-color-main);
      }
    }

    &[open] {
      summary::before {
        transform: translateY(-50%) rotate(90deg);
      }
    }

    // 内容区域样式
    .details-content,
    >*:not(summary) {
      padding: 24px;
      line-height: 1.6;
      border-top: 1px solid var(--card-border);

      &:first-of-type {
        margin-top: 0;
      }

      &:last-child {
        margin-bottom: 0;
      }
    }

    // 如果内容直接在 details 下，不在 .details-content 包装中
    >p,
    >ul,
    >ol,
    >pre,
    >blockquote,
    >div:not(.details-content),
    >h1,
    >h2,
    >h3,
    >h4,
    >h5,
    >h6 {
      margin-left: 24px;
      margin-right: 24px;

      &:first-of-type {
        margin-top: 24px;
        padding-top: 0;
        border-top: 1px solid var(--card-border);
      }

      &:last-child {
        margin-bottom: 24px;
      }
    }

    // 确保基本的代码样式在 details 中工作
    code:not(pre code) {
      background: rgba(0, 0, 0, 0.15);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    // 嵌套的 blockquote 样式调整
    blockquote {
      margin: 16px 0;
      border-left-width: 3px;
      padding: 16px 20px;
      border-radius: 6px;
    }

    // 表格样式调整
    table {
      margin: 16px 0;
      border-radius: 6px;
      overflow: hidden;
    }

    // 暗色模式优化
    :root[data-scheme="dark"] & {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);

      &:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      }

      summary {
        background: linear-gradient(135deg, rgba(var(--accent-color-rgb), 0.2) 0%, rgba(var(--accent-color-rgb), 0.1) 100%);

        &:hover {
          background: linear-gradient(135deg, rgba(var(--accent-color-rgb), 0.3) 0%, rgba(var(--accent-color-rgb), 0.2) 100%);
        }
      }
    }
  }
}