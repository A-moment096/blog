<!-- 加载进度条 -->
<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js"
    integrity="sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg"
    crossorigin="anonymous"
></script>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css"
    integrity="sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE"
    crossorigin="anonymous"
/>
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>

<!-- 回到顶部 -->
<div id="back-top">
    <a href="#top" title="To Top">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="back-top-icon">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M6 15l6 -6l6 6" />
        </svg>
    </a>
</div>

<style>
    #back-top {
        position: fixed;
        bottom: 30px; /* Fixed bottom position */
        right: 30px; /* Default right position for mobile/fallback */
        background: var(--card-background);
        border: 1px solid var(--card-separator-color);
        border-radius: 7px;
        padding: 10px;
        z-index: 1000;
        opacity: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0);
        transition: opacity 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, right 0.3s ease;
    }

    #back-top.show {
        opacity: 1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #back-top a {
        text-decoration: none;
        color: var(--card-text-color-main);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .back-top-icon {
        transition: color 0.3s ease, transform 0.3s ease;
    }

    #back-top:hover {
        background: var(--card-background-selected);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    #back-top:hover .back-top-icon {
        color: white;
        transform: translateY(-1px);
    }

    /* 确保在浅色模式下也有合适的悬浮效果 */
    [data-scheme="light"] #back-top:hover .back-top-icon {
        color: var(--accent-color);
    }

    /* 深色模式下的特殊悬浮效果 */
    [data-scheme="dark"] #back-top:hover .back-top-icon {
        color: white;
    }
</style>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var backTopButton = document.getElementById('back-top');
        var rightSidebar = document.querySelector('.right-sidebar');
        
        function positionBackTopButton() {
            if (rightSidebar && window.innerWidth >= 1024) { // lg breakpoint
                var sidebarRect = rightSidebar.getBoundingClientRect();
                // Calculate right position to align with sidebar's right edge
                var rightPosition = window.innerWidth - sidebarRect.right + window.scrollX;
                backTopButton.style.right = rightPosition + 'px';
            } else {
                // Fallback to default right position for mobile or when no sidebar
                backTopButton.style.right = '30px';
            }
        }

        function handleScroll() {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                backTopButton.classList.add('show');
                positionBackTopButton(); // Update horizontal position when showing
            } else {
                backTopButton.classList.remove('show');
            }
        }

        // Position button on load and window resize
        window.addEventListener('resize', positionBackTopButton);
        window.addEventListener('scroll', handleScroll);
        
        // Initial positioning
        positionBackTopButton();

        backTopButton.onclick = function (event) {
            event.preventDefault(); // Prevent default anchor behavior
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scroll to top
            });
        };
    });
</script>

<!-- Universal Widget Collapse/Expand Functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Detect page type
        const isPostPage = document.body.classList.contains('article-page');
        
        // Find all widgets with headers
        const widgets = document.querySelectorAll('.widget');
        
        widgets.forEach(widget => {
            const widgetBody = widget.querySelector('.widget-body');
            const widgetHeader = widget.querySelector('.widget-header');
            
            if (widgetBody && widgetHeader) {
                // Set initial state based on page type and widget type
                const isTOCWidget = widget.classList.contains('archives') && widget.querySelector('.widget--toc');
                
                if (isPostPage) {
                    // On post pages: expand only TOC, collapse others
                    if (isTOCWidget) {
                        expandWidget(widgetHeader, widgetBody);
                    } else {
                        collapseWidget(widgetHeader, widgetBody);
                    }
                } else {
                    // On other pages: expand all widgets
                    expandWidget(widgetHeader, widgetBody);
                }
                
                // Make entire header clickable
                widgetHeader.addEventListener('click', function() {
                    toggleWidget(widgetHeader, widgetBody);
                });
            }
        });
        
        function toggleWidget(widgetHeader, widgetBody) {
            const isExpanded = widgetBody.classList.contains('show');
            
            if (isExpanded) {
                collapseWidget(widgetHeader, widgetBody);
            } else {
                expandWidget(widgetHeader, widgetBody);
            }
        }
        
        function expandWidget(widgetHeader, widgetBody) {
            widgetBody.classList.add('show');
            widgetHeader.classList.add('expanded');
            widgetBody.style.display = 'block';
        }
        
        function collapseWidget(widgetHeader, widgetBody) {
            widgetBody.classList.remove('show');
            widgetHeader.classList.remove('expanded');
            widgetBody.style.display = 'none';
        }
    });
</script>
