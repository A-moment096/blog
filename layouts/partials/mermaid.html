{{- if .Page.Params.mermaid }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    mermaid.initialize({
      startOnLoad: true,
      theme: document.documentElement.getAttribute('data-scheme') === 'dark' ? 'dark' : 'default',
      securityLevel: 'loose',
      fontFamily: 'inherit',
      flowchart: {
        htmlLabels: true,
        curve: 'basis'
      },
      sequence: {
        diagramMarginX: 50,
        diagramMarginY: 10,
        actorMargin: 50,
        width: 150,
        height: 65,
        boxMargin: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35,
        mirrorActors: true,
        bottomMarginAdj: 1,
        useMaxWidth: true,
        rightAngles: false,
        showSequenceNumbers: false
      },
      gantt: {
        titleTopMargin: 25,
        barHeight: 20,
        fontSizeTitleTopMargin: 16,
        fontSize: 11,
        fontFamily: 'inherit',
        section: 0,
        numberSectionStyles: 4,
        axisFormat: '%Y-%m-%d'
      }
    });

    // Handle theme changes (for Stack theme's dark mode toggle)
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
          const currentTheme = document.documentElement.getAttribute('data-scheme');
          mermaid.initialize({
            theme: currentTheme === 'dark' ? 'dark' : 'default'
          });
          // Re-render all mermaid diagrams
          document.querySelectorAll('.mermaid').forEach(function(element) {
            element.removeAttribute('data-processed');
          });
          mermaid.init();
        }
      });
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-scheme']
    });
  });
</script>
{{- end }}
